#!/bin/bash

# Created by Robert Edward Steckroth II, RobertSteckroth@gmail.com

set -eux # -x for verbose logging to juju debug-log

juju-log "Starting installation of Django-rainbow"

native_packages=`config-get rainbow-packages`
additional_debian_packages=`config-get additional-debian-packages`
additional_pip_packages=`config-get additional-pip-packages`
reinstall_mysql=`config-get re-install-mysql-server`
purge_instance=`config-get purge-instance`
package_directory=`config-get package-installation-directory`

if ! [ -e "$package_directory" ]; then
       if ( ! mkdir -p $package_directory 2> /dev/null ); then
          # Not gonna allow bad package installation directory
            package_directory="/var/lib/django-rainbow/packages"
            mkdir -p $package_directory
       fi
fi

# Reinstall and store packages if specified in config with "purge_instance"
if [ -n "$purge_instance" ]; then
     juju-log "Purging instance"
   # Remove tralling slash at the end for consitancy
     package_directory="$(echo $package_directory | sed 's/\(.*\)\/$/\1/g')"
   # Remove all stock packages
     juju-log "REMOVING $native_packages via apt-get"
     apt-get -y purge $native_packages
   # Re-install all stock packages
     juju-log "RE-INSTALLING $native_packages via apt-get"
     apt-get -qqy install $native_packages

   # Gonna store our packages in case of a service destroy
     if ! [ -e "$package_directory/installed" ]; then
            touch $package_directory/installed
     fi

   # Erase data and poplulate a temp file for listed packages
     echo "" > $package_directory/temp_installed
     for pkg in $(echo "$additional_debian_packages"); do
         echo "$pkg" >> $package_directory/temp_installed
     done;

     # Installed file now contains any packages to be removed from previous install
     for remove_pkg in $(cat $package_directory/installed); do
         [ -z "$remove_pkg" ] && continue     # Dont need empty data
         # Can't have spaces either
         remove_pkg="$(echo "$remove_pkg" | sed 's/\ *//g')"
         juju-log "Removing package $remove_pkg"
         apt-get -qqy purge $remove_pkg
      done;

   # Add all packages to the installed file for next run re-installation
     new_list="$(comm -13 <(sort $package_directory/installed) <(sort $package_directory/temp_installed))"
     cp $package_directory/temp_installed $package_directory/installed

   # Installed file now contains all packages to be installed now
     for install_pkg in $(cat $package_directory/installed); do
         [ -z "$install_pkg" ] && continue   # Dont need empty data
         # Can't have spaces either
         install_pkg="$(echo "$install_pkg" | sed 's/\ *//g')"
         juju-log "Installing package $install_pkg"
         apt-get -qqy install $install_pkg
     done;
else
   # Just try to install stock packages
     juju-log "Installing $native_packages via apt-get"
     apt-get -qqy install $native_packages
     if [ -n "$additional_debian_packages" ]; then
          juju-log "Installing extra debian packages: $additional_debian_packages"
          apt-get -qqy install $additional_debian_packages
     fi
fi # Endo if [ -n "$purge_instance" ]; then

cd $package_directory

if ! [ -e "Django-1.4" ]; then 
       wget https://www.djangoproject.com/download/1.4/tarball
       tar -xvf tarball
       python Django-1.4/setup.py install
fi

juju-log "Checking for package mysql-server..."
if ( dpkg -s mysql-server | grep installed 2> /dev/null ); then
     juju-log "...installed"
     package="installed"
else
     juju-log "...not installed"
     package=""
fi 


if [ -z "$package" -o -n "$reinstall_mysql" ]; then
     if [ -n "$package" ]; then
          juju-log "Removing mysql client and all settings"
          apt-get -qqy purge debconf-utils mysql-client-core-5.5 mysql-server 
     fi
     juju-log "Installing mysql-server and client"
     apt-get -qqy install mysql-client-core-5.5 debconf-utils
   # Generate a strong root password for the mysql service, using /dev/urandom
     PASSWORD=`pwgen 10 1`
   # Store the password for later use by the rainbow-relation-changed hook for this service unit.
     echo $PASSWORD > /var/lib/juju/mysql.passwd
     echo mysql-server-5.1 mysql-server/root_password password $PASSWORD | debconf-set-selections
     echo mysql-server-5.1 mysql-server/root_password_again password $PASSWORD | debconf-set-selections
     juju-log "mysql-server settings preseeded, now installing via apt-get"
     DEBIAN_FRONTEND=noninteractive apt-get -y install -qq mysql-server
     juju-log "Editing my.cnf to allow listening on all interfaces"
     sed --in-place=old 's/127\.0\.0\.1/0.0.0.0/' /etc/mysql/my.cnf
     juju-log "Restarting mysql"
     /etc/init.d/mysql restart
fi


a2dissite default
/etc/init.d/apache2 restart


